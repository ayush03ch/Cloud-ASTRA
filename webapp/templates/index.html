<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Security Agent - Cloud Astra</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .intent-mapping {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .intent-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }
        
        .intent-item input[type="text"] {
            flex: 1;
            margin: 0;
        }
        
        .intent-item select {
            flex: 1;
            margin: 0;
        }
        
        .add-intent-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .add-intent-btn:hover {
            background: #218838;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 150px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .results {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .results h3 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .result-item.warning {
            border-left-color: #ffc107;
        }
        
        .result-item.error {
            border-left-color: #dc3545;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .help-text {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        
        .manual-fix-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #fff9e6;
            border-radius: 6px;
            border: 1px solid #ffd700;
        }
        
        .fix-instructions {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .fix-instructions h5 {
            margin-bottom: 8px;
            color: #495057;
            font-size: 14px;
        }
        
        .fix-instructions ul {
            margin-left: 20px;
            color: #6c757d;
        }
        
        .fix-instructions li {
            margin-bottom: 4px;
            font-size: 13px;
        }
        
        .apply-fix-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        .apply-fix-btn:hover {
            background: #138496;
        }
        
        .apply-fix-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e5e9;
        }
        
        .tab-button {
            padding: 15px 25px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab-button:hover {
            color: #667eea;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Cloud Astra</h1>
            <p>Intent-Aware AWS Security Scanner & Auto-Remediation</p>
        </div>
        
        <div class="tabs">
            <button type="button" class="tab-button active" onclick="switchTab('s3')">
                üì¶ S3 Agent
            </button>
            <button type="button" class="tab-button" onclick="switchTab('lambda')">
                ‚ö° Lambda Agent
            </button>
        </div>
        
        <!-- S3 Agent Tab -->
        <div id="s3-tab" class="tab-content active">
            <form id="s3ScanForm">
                <div class="form-section">
                    <h3>üîê AWS Configuration</h3>
                    <div class="form-group">
                        <label for="s3RoleArn">Target Account IAM Role ARN:</label>
                        <input type="text" id="s3RoleArn" name="roleArn" 
                               value=""  
                               placeholder="arn:aws:iam::ACCOUNT-ID:role/ROLE-NAME">
                        <div class="help-text">IAM role in the target AWS account that the agent will assume</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="s3ExternalId">External ID:</label>
                        <input type="text" id="s3ExternalId" name="externalId" 
                               value="my-s3-agent-2025" 
                               placeholder="External ID for role assumption">
                        <div class="help-text">Additional security measure for cross-account role assumption</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="s3Region">AWS Region:</label>
                        <select id="s3Region" name="region">
                            <option value="us-east-1" selected>US East (N. Virginia)</option>
                            <option value="us-west-2">US West (Oregon)</option>
                            <option value="eu-west-1">Europe (Ireland)</option>
                            <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>üéØ Bucket Intent Configuration</h3>
                    <p style="margin-bottom: 20px; color: #666;">
                        Specify the intended purpose for each bucket to guide intelligent fixes:
                    </p>
                    
                    <div id="s3IntentMappings">
                        <div class="intent-item">
                            <input type="text" placeholder="Bucket name (e.g., my-website-bucket)" 
                                   name="bucketName[]" style="flex: 1.2;">
                            <select name="bucketIntent[]" style="flex: 1;">
                                <option value="">Auto-detect</option>
                                <option value="website hosting">üåê Website Hosting</option>
                                <option value="data storage">üì¶ Data Storage</option>
                                <option value="data archival">üóÑÔ∏è Data Archival</option>
                                <option value="backup storage">üíæ Backup Storage</option>
                                <option value="log storage">üìä Log Storage</option>
                            </select>
                            <button type="button" class="remove-intent-btn" onclick="removeS3Intent(this)" 
                                    style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï</button>
                        </div>
                    </div>
                    
                    <button type="button" class="add-intent-btn" onclick="addS3IntentMapping()">
                        ‚ûï Add Bucket Intent
                    </button>
                    
                    <div class="help-text" style="margin-top: 15px;">
                        üí° <strong>Smart Intent Detection:</strong> Leave intent as "Auto-detect" to let the system analyze bucket configuration, 
                        contents, and naming patterns to determine purpose automatically.
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>‚öôÔ∏è Scan Options</h3>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="s3AllowConversion" name="allowConversion" checked>
                        <label for="s3AllowConversion" style="margin: 0;">
                            üîÑ Allow bucket purpose conversion (e.g., website ‚Üí data storage if no HTML files)
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="s3AutoFix" name="autoFix" checked>
                        <label for="s3AutoFix" style="margin: 0;">
                            üîß Enable automatic fixes for safe security issues
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="s3DetailedLogging" name="detailedLogging">
                        <label for="s3DetailedLogging" style="margin: 0;">
                            üìù Enable detailed logging and reasoning output
                        </label>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">
                        üöÄ Start S3 Security Scan
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearS3Form()">
                        üßπ Clear Form
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Lambda Agent Tab -->
        <div id="lambda-tab" class="tab-content">
            <form id="lambdaScanForm">
                <div class="form-section">
                    <h3>üîê AWS Configuration</h3>
                    <div class="form-group">
                        <label for="lambdaRoleArn">Target Account IAM Role ARN:</label>
                        <input type="text" id="lambdaRoleArn" name="roleArn" 
                               value=""  
                               placeholder="arn:aws:iam::ACCOUNT-ID:role/ROLE-NAME">
                        <div class="help-text">IAM role in the target AWS account that the agent will assume</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="lambdaExternalId">External ID:</label>
                        <input type="text" id="lambdaExternalId" name="externalId" 
                               value="my-s3-agent-2025" 
                               placeholder="External ID for role assumption">
                        <div class="help-text">Additional security measure for cross-account role assumption</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="lambdaRegion">AWS Region:</label>
                        <select id="lambdaRegion" name="region">
                            <option value="us-east-1" selected>US East (N. Virginia)</option>
                            <option value="us-west-2">US West (Oregon)</option>
                            <option value="eu-west-1">Europe (Ireland)</option>
                            <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>‚ö° Lambda Function Intent Configuration</h3>
                    <p style="margin-bottom: 20px; color: #666;">
                        Specify the intended purpose for each Lambda function to guide intelligent fixes:
                    </p>
                    
                    <div id="lambdaIntentMappings">
                        <div class="intent-item">
                            <input type="text" placeholder="Function name (e.g., my-api-handler)" 
                                   name="functionName[]" style="flex: 1.2;">
                            <select name="functionIntent[]" style="flex: 1;">
                                <option value="">Auto-detect</option>
                                <option value="api_endpoint">üîå API Endpoint</option>
                                <option value="scheduled_task">‚è∞ Scheduled Task</option>
                                <option value="event_processor">üì® Event Processor</option>
                                <option value="stream_processor">üåä Stream Processor</option>
                                <option value="notification_handler">üîî Notification Handler</option>
                                <option value="data_transformation">üîÑ Data Transformation</option>
                            </select>
                            <button type="button" class="remove-intent-btn" onclick="removeLambdaIntent(this)" 
                                    style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï</button>
                        </div>
                    </div>
                    
                    <button type="button" class="add-intent-btn" onclick="addLambdaIntentMapping()">
                        ‚ûï Add Function Intent
                    </button>
                    
                    <div class="help-text" style="margin-top: 15px;">
                        üí° <strong>Smart Intent Detection:</strong> Leave intent as "Auto-detect" to let the system analyze function configuration, 
                        environment variables, and naming patterns to determine purpose automatically.
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>‚öôÔ∏è Scan Options</h3>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="lambdaAutoFix" name="autoFix" checked>
                        <label for="lambdaAutoFix" style="margin: 0;">
                            üîß Enable automatic fixes for safe security issues
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="lambdaDetailedLogging" name="detailedLogging">
                        <label for="lambdaDetailedLogging" style="margin: 0;">
                            üìù Enable detailed logging and reasoning output
                        </label>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">
                        üöÄ Start Lambda Security Scan
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearLambdaForm()">
                        üßπ Clear Form
                    </button>
                </div>
            </form>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Scanning AWS account and applying intelligent fixes...</p>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                This may take a few moments while we analyze your resources and apply context-aware fixes.
            </p>
        </div>
        
        <div class="results" id="results">
            <h3>üìä Scan Results</h3>
            <div id="resultsContent"></div>
        </div>
    </div>
    
    <script>
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.getElementById('s3-tab').classList.remove('active');
            document.getElementById('lambda-tab').classList.remove('active');
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            if (tabName === 's3') {
                document.getElementById('s3-tab').classList.add('active');
                event.target.classList.add('active');
            } else if (tabName === 'lambda') {
                document.getElementById('lambda-tab').classList.add('active');
                event.target.classList.add('active');
            }
        }
        
        // S3 Functions
        function addS3IntentMapping() {
            const container = document.getElementById('s3IntentMappings');
            const newItem = document.createElement('div');
            newItem.className = 'intent-item';
            newItem.innerHTML = `
                <input type="text" placeholder="Bucket name" name="bucketName[]" style="flex: 1.2;">
                <select name="bucketIntent[]" style="flex: 1;">
                    <option value="">Auto-detect</option>
                    <option value="website hosting">üåê Website Hosting</option>
                    <option value="data storage">üì¶ Data Storage</option>
                    <option value="data archival">üóÑÔ∏è Data Archival</option>
                    <option value="backup storage">üíæ Backup Storage</option>
                    <option value="log storage">üìä Log Storage</option>
                </select>
                <button type="button" class="remove-intent-btn" onclick="removeS3Intent(this)" 
                        style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï</button>
            `;
            container.appendChild(newItem);
        }
        
        function removeS3Intent(button) {
            const container = document.getElementById('s3IntentMappings');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }
        
        function clearS3Form() {
            document.getElementById('s3ScanForm').reset();
            document.getElementById('results').classList.remove('show');
            
            const container = document.getElementById('s3IntentMappings');
            container.innerHTML = `
                <div class="intent-item">
                    <input type="text" placeholder="Bucket name (e.g., my-website-bucket)" 
                           name="bucketName[]" style="flex: 1.2;">
                    <select name="bucketIntent[]" style="flex: 1;">
                        <option value="">Auto-detect</option>
                        <option value="website hosting">üåê Website Hosting</option>
                        <option value="data storage">üì¶ Data Storage</option>
                        <option value="data archival">üóÑÔ∏è Data Archival</option>
                        <option value="backup storage">üíæ Backup Storage</option>
                        <option value="log storage">üìä Log Storage</option>
                    </select>
                    <button type="button" class="remove-intent-btn" onclick="removeS3Intent(this)" 
                            style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï</button>
                </div>
            `;
        }
        
        // Lambda Functions
        function addLambdaIntentMapping() {
            const container = document.getElementById('lambdaIntentMappings');
            const newItem = document.createElement('div');
            newItem.className = 'intent-item';
            newItem.innerHTML = `
                <input type="text" placeholder="Function name" name="functionName[]" style="flex: 1.2;">
                <select name="functionIntent[]" style="flex: 1;">
                    <option value="">Auto-detect</option>
                    <option value="api_endpoint">üîå API Endpoint</option>
                    <option value="scheduled_task">‚è∞ Scheduled Task</option>
                    <option value="event_processor">üì® Event Processor</option>
                    <option value="stream_processor">üåä Stream Processor</option>
                    <option value="notification_handler">üîî Notification Handler</option>
                    <option value="data_transformation">üîÑ Data Transformation</option>
                </select>
                <button type="button" class="remove-intent-btn" onclick="removeLambdaIntent(this)" 
                        style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï</button>
            `;
            container.appendChild(newItem);
        }
        
        function removeLambdaIntent(button) {
            const container = document.getElementById('lambdaIntentMappings');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }
        
        function clearLambdaForm() {
            document.getElementById('lambdaScanForm').reset();
            document.getElementById('results').classList.remove('show');
            
            const container = document.getElementById('lambdaIntentMappings');
            container.innerHTML = `
                <div class="intent-item">
                    <input type="text" placeholder="Function name (e.g., my-api-handler)" 
                           name="functionName[]" style="flex: 1.2;">
                    <select name="functionIntent[]" style="flex: 1;">
                        <option value="">Auto-detect</option>
                        <option value="api_endpoint">üîå API Endpoint</option>
                        <option value="scheduled_task">‚è∞ Scheduled Task</option>
                        <option value="event_processor">üì® Event Processor</option>
                        <option value="stream_processor">üåä Stream Processor</option>
                        <option value="notification_handler">üîî Notification Handler</option>
                        <option value="data_transformation">üîÑ Data Transformation</option>
                    </select>
                    <button type="button" class="remove-intent-btn" onclick="removeLambdaIntent(this)" 
                            style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úï</button>
                </div>
            `;
        }
        
        // Shared functions
        function displayResults(result) {
            const resultsContent = document.getElementById('resultsContent');
            const results = document.getElementById('results');
            
            if (result.error) {
                resultsContent.innerHTML = `
                    <div class="result-item error">
                        <h4>‚ùå Error</h4>
                        <p>${result.error}</p>
                    </div>
                `;
            } else {
                let html = `
                    <div class="result-item">
                        <h4>üìä Scan Summary</h4>
                        <p><strong>Issues Found:</strong> ${result.findings_count || 0}</p>
                        <p><strong>Auto-fixes Applied:</strong> ${result.auto_fixes_applied?.length || 0}</p>
                        <p><strong>Manual Reviews Needed:</strong> ${result.pending_fixes?.length || 0}</p>
                        ${result.auto_fix_summary?.success_rate ? `
                            <p><strong>Auto-fix Success Rate:</strong> ${result.auto_fix_summary.success_rate.toFixed(1)}%</p>
                        ` : ''}
                    </div>
                `;
                
                if (result.auto_fixes_applied?.length > 0) {
                    html += `
                        <div class="result-item">
                            <h4>‚úÖ Auto-fixes Applied</h4>
                            ${result.auto_fixes_applied.map(fix => `
                                <p>‚Ä¢ <strong>${fix.resource}:</strong> ${fix.status} - ${fix.details || 'Applied successfully'}</p>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (result.pending_fixes?.length > 0) {
                    html += `
                        <div class="result-item warning">
                            <h4>‚ö†Ô∏è Manual Review Required</h4>
                            ${result.pending_fixes.map((fix, index) => `
                                <div class="manual-fix-item">
                                    <p><strong>${fix.resource}:</strong> ${fix.issue}</p>
                                    ${fix.fix_instructions ? `
                                        <div class="fix-instructions">
                                            <h5>üîß How to Fix:</h5>
                                            <ul>
                                                ${fix.fix_instructions.map(instruction => `<li>${instruction}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${fix.can_auto_fix ? `
                                        <button class="apply-fix-btn" onclick="applyManualFix('${fix.resource}', '${fix.fix_type}', ${index})">
                                            ü§ñ Let Agent Fix This
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (result.intent_decisions?.length > 0) {
                    html += `
                        <div class="result-item">
                            <h4>üéØ Intent Detection Results</h4>
                            ${result.intent_decisions.map(decision => `
                                <p>‚Ä¢ <strong>${decision.bucket || decision.function}:</strong> ${decision.intent} (confidence: ${decision.confidence})</p>
                                <p style="margin-left: 20px; color: #666; font-size: 0.9em;">${decision.reasoning}</p>
                            `).join('')}
                        </div>
                    `;
                }
                
                resultsContent.innerHTML = html;
            }
            
            results.classList.add('show');
            results.scrollIntoView({ behavior: 'smooth' });
        }
        
        function displayError(message) {
            const resultsContent = document.getElementById('resultsContent');
            const results = document.getElementById('results');
            
            resultsContent.innerHTML = `
                <div class="result-item error">
                    <h4>‚ùå Connection Error</h4>
                    <p>${message}</p>
                    <p style="margin-top: 10px; font-size: 14px;">
                        Make sure to start the backend server with: <code>python webapp/app.py</code>
                    </p>
                </div>
            `;
            
            results.classList.add('show');
        }
        
        async function applyManualFix(resource, fixType, index) {
            const button = event.target;
            const originalText = button.textContent;
            
            // Disable button and show loading
            button.disabled = true;
            button.textContent = 'üîÑ Applying Fix...';
            
            try {
                // Determine which form is active
                const s3Form = document.getElementById('s3ScanForm');
                const lambdaForm = document.getElementById('lambdaScanForm');
                const activeTab = document.getElementById('s3-tab').classList.contains('active') ? 's3' : 'lambda';
                
                let roleArn, externalId, region;
                if (activeTab === 's3') {
                    roleArn = document.getElementById('s3RoleArn').value;
                    externalId = document.getElementById('s3ExternalId').value;
                    region = document.getElementById('s3Region').value;
                } else {
                    roleArn = document.getElementById('lambdaRoleArn').value;
                    externalId = document.getElementById('lambdaExternalId').value;
                    region = document.getElementById('lambdaRegion').value;
                }
                
                // Send fix request
                const response = await fetch('/api/apply-manual-fix', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        role_arn: roleArn,
                        external_id: externalId,
                        region: region,
                        resource: resource,
                        fix_type: fixType,
                        service: activeTab
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    button.textContent = '‚úÖ Fixed!';
                    button.style.background = '#28a745';
                    
                    // Show success message
                    const fixItem = button.closest('.manual-fix-item');
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'margin-top: 10px; padding: 8px; background: #d4edda; color: #155724; border-radius: 4px; font-size: 13px;';
                    successMsg.innerHTML = `‚úÖ ${result.message || 'Fix applied successfully!'}`;
                    fixItem.appendChild(successMsg);
                    
                } else {
                    throw new Error(result.error || 'Fix failed');
                }
                
            } catch (error) {
                console.error('Fix error:', error);
                button.disabled = false;
                button.textContent = originalText;
                
                // Show error message
                const fixItem = button.closest('.manual-fix-item');
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = 'margin-top: 10px; padding: 8px; background: #f8d7da; color: #721c24; border-radius: 4px; font-size: 13px;';
                errorMsg.innerHTML = `‚ùå ${error.message}`;
                fixItem.appendChild(errorMsg);
            }
        }
        
        // S3 Form submission
        document.getElementById('s3ScanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
            
            // Collect form data
            const formData = new FormData(e.target);
            const data = {
                service: 's3',
                role_arn: formData.get('roleArn'),
                external_id: formData.get('externalId'),
                region: formData.get('region'),
                allow_conversion: formData.get('allowConversion') === 'on',
                auto_fix: formData.get('autoFix') === 'on',
                detailed_logging: formData.get('detailedLogging') === 'on',
                user_intent_input: {}
            };
            
            // Collect bucket intents
            const bucketNames = formData.getAll('bucketName[]');
            const bucketIntents = formData.getAll('bucketIntent[]');
            
            for (let i = 0; i < bucketNames.length; i++) {
                if (bucketNames[i].trim() && bucketIntents[i]) {
                    data.user_intent_input[bucketNames[i].trim()] = bucketIntents[i];
                }
            }
            
            try {
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                // Hide loading
                document.getElementById('loading').classList.remove('show');
                
                // Show results
                displayResults(result);
                
            } catch (error) {
                document.getElementById('loading').classList.remove('show');
                displayError('Connection failed. Make sure the backend server is running.');
            }
        });
        
        // Lambda Form submission
        document.getElementById('lambdaScanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
            
            // Collect form data
            const formData = new FormData(e.target);
            const data = {
                service: 'lambda',
                role_arn: formData.get('roleArn'),
                external_id: formData.get('externalId'),
                region: formData.get('region'),
                auto_fix: formData.get('autoFix') === 'on',
                detailed_logging: formData.get('detailedLogging') === 'on',
                user_intent_input: {}
            };
            
            // Collect function intents
            const functionNames = formData.getAll('functionName[]');
            const functionIntents = formData.getAll('functionIntent[]');
            
            for (let i = 0; i < functionNames.length; i++) {
                if (functionNames[i].trim() && functionIntents[i]) {
                    data.user_intent_input[functionNames[i].trim()] = functionIntents[i];
                }
            }
            
            try {
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                // Hide loading
                document.getElementById('loading').classList.remove('show');
                
                // Show results
                displayResults(result);
                
            } catch (error) {
                document.getElementById('loading').classList.remove('show');
                displayError('Connection failed. Make sure the backend server is running.');
            }
        });
    </script>
</body>
</html>